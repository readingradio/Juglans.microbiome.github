---
title: "ITS2_soil_FA19_ajo"
author: "Aaron Onufrak"
date: "11/20/2019"
output: rmdformats::readthedown
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Packages
The following code uses several packages including vegan for community ecology, tidyr and plyr for organizing data tables and manipulating strings of text, and ggplot for plotting data. 
```{r Packages, results='hide', message=FALSE}
#In this chunk I load all of the requisite packages.
library(vegan)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(plyr)
library(data.table)
library(RColorBrewer)
library(ape)
library(car)
library(Hmisc)
library(corrplot)
library(plotly)
library(knitr)
library(kableExtra)
library(DT)
```

# Data Import and Subsetting
## Data Import
Below ITS data from bulk soils collected from 47 *Juglans nigra* trees are imported into R. This includes a rarefied OTU table from mothur, the sample metadata which indicates the state from which the sample was collected and clone ID, and the taxonomic classifications for each OTU. Samples were rarefied to 25,000 sequences in mothur prior to import, resulting in the loss of two samples from WA. Taxonomic assignments were made in mothur using the UNITE database. 
```{r Data Import}
# Below I am importing the rarefied OTU table for ITS2 from the caulosphere. This table was rarefied in mothur prior to importing into R to 25000 sequences per sample.  
its2.soil.rareotu.wsingles<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2otutable.rarefied_jnigra17_fa19_gw.shared", header=TRUE, sep="\t", row.names=2)

#Next I import the metadata for the particular habitat of interest. In this case I am working with soil. I will use this metadata to subset the larger OTU file above. 
its2.soil.met<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2metadata_jnigra17_su19_ajo.txt",header=TRUE,sep="\t",fill=TRUE,strip.white=TRUE)

#Next I import the taxonomy file.
its2.taxonomy.soil<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2taxonomy_jnigra17_fa19_gw.cons.taxonomy",header=TRUE,sep="\t",fill=TRUE,strip.white=TRUE,row.names=1)

its2.soil.names<-its2.soil.met$Group
```

## Data Subsetting
Below subset the OTU table to remove Mothur inserted metadata which indicates the percent identity threshold and the number of OTUs. I then remove singleton OTUs, OTUs that have only one 1 sequence following rarefaction.
```{r Data Subsetting}
#Below I remove the mothur associated metadata present in the first two columns to generate a matrix that consists of only OTU raw counts. 
its2.soil.rareotu<-as.data.frame(its2.soil.rareotu.wsingles[,3:10579])

#I am now removing singleton OTUs (OTUs with only 1 sequence following rarefaction). This is to limit the effects of rare species on our distance matrices used during ordination.  
its2.soil.rareotu.nosingletons<-as.data.frame(its2.soil.rareotu[,colSums(its2.soil.rareotu)>1])

#The following line is for saving the rarefied OTU table with singletons removed. This file is later reloaded to be used in downstream analyses. This is done to maintain consistency of results because rarefying generates slightly different results each time. 
#write.table(its2.soil.rareotu.nosingletons, "/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2otutable.rarefied.nosingleton_jnigra17_fa19_gw_ajo.shared",sep="\t", row.names=TRUE)

#I then subset the metadata to remove sample names from the metadata that were removed following rarefaction. 
its2.soil.met.rare<-subset(its2.soil.met,its2.soil.met$Group%in%labels(its2.soil.rareotu.wsingles)[[1]])
```

# Good's Coverage
```{r}
library(QsRutils)
goods(its2.soil.rareotu)
```

# Relative Abundance Charts
To visualize differences in the relative abundance of different taxa I reorganize the OTU table and taxonomy strings to create relative abundance stacked bar charts. Below, stacked bar charts are made for phylum, class, and order levels.

## Taxonomy Subsetting
To begin, the taxonomy file is subsetted to include only taxonomy information for OTUs present in the rarefied OTU table with singletons removed. The OTU table is first transposed so that OTU IDs are the row names and sample names are the column names. Then the taxonomic assignments are added to the OTU table. Taxonomic strings are then split by semi-colon into individual columns by Phylum, Class, Order, Family, Genus, and Species.
```{r Taxonomy Subsetting, warning=FALSE}
#Using the rarefied OTU tables I can generate relative abundance charts for the different taxonomic levels.To begin I first reformat the OTU table so that I can do some filtering and add taxonomy information. 
its2.soil.rareotu.nosingles<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2otutable.rarefied.nosingleton_jnigra17_fa19_gw_ajo.shared", header=TRUE, sep="\t")

#I now transpose my OTU table so that I can begin to add in taxonomy information. 
t.its2.soil.rareotu.nosingles<-as.data.frame(t(its2.soil.rareotu.nosingles))

#The below function is asking specifically for the OTU Isoil. These are the row names. I will use these to subset the taxonomy file. 
t.its2.soil.rareotu.nosingleslabs<-labels(t.its2.soil.rareotu.nosingles)
its2.soil.taxrare<-subset(its2.taxonomy.soil, rownames(its2.taxonomy.soil) %in% t.its2.soil.rareotu.nosingleslabs[[1]])

#Now I am subsetting the new taxonomy file to include only the taxonomy information stored in column 2. 
its2.soil.taxrareinfo<-(its2.soil.taxrare[,2])

#Below I am using the separate function from tidyr to split the taxonomy strings into columns by semi-colon so that I can rename the OTUs to give them more meaning for downstream analyses.
library(tidyr)

#The UNITE database only provides classifications up to species level, thus, new columns are created up to species level.
its2.soil.taxonomylabs<-c("kingdom","phylum","class","order","family","genus","species")

#Below I create a new data frame with a column containing taxonomy information. 
t.its2.soil.rareotutabtax<-data.frame(taxonomy=its2.soil.taxrareinfo,t.its2.soil.rareotu.nosingles)

#I then separate the taxonomy strings into new columns labeled with the taxonomy labels saved in the taxonomylabs object. Strings are being separated based on the presence of semi-colons. 
t.its2.soil.rareotutabtaxsep<-separate(t.its2.soil.rareotutabtax,into=its2.soil.taxonomylabs,col=taxonomy,sep=";")
```

## Relative Abundance OTU Table
I then create a relative abundance OTU table. This table contains taxonomic information and can be searched to look at specific OTUs more easily. 
```{r Relative Abundance OTU Table, warning=FALSE}
#Using the rarefied OTU tables I can generate relative abundance charts for the different taxonomic levels.To begin I first reformat the OTU table so that I can do some filtering and add taxonomy information. 
its2.soil.rareotu.nosingles<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2otutable.rarefied.nosingleton_jnigra17_fa19_gw_ajo.shared", header=TRUE, sep="\t")

its2.soil.rareotu.nosingles.table<-decostand(its2.soil.rareotu.nosingles,method="total")

#I now transpose my OTU table so that I can begin to add in taxonomy information. 
t.its2.soil.rareotu.nosingles.table<-as.data.frame(t(its2.soil.rareotu.nosingles.table))

#The below function is asking specifically for the OTU Isoil. These are the row names. I will use these to subset the taxonomy file. 
t.its2.soil.rareotu.nosingleslabs<-labels(t.its2.soil.rareotu.nosingles.table)
its2.soil.taxrare<-subset(its2.taxonomy.soil, rownames(its2.taxonomy.soil) %in% t.its2.soil.rareotu.nosingleslabs[[1]])

#Now I am subsetting the new taxonomy file to include only the taxonomy information stored in column 2. 
its2.soil.taxrareinfo<-(its2.soil.taxrare[,2])

#Below I am using the separate function from tidyr to split the taxonomy strings into columns by semi-colon so that I can rename the OTUs to give them more meaning for downstream analyses.
library(tidyr)

#The UNITE database only provides classifications up to species level, thus, new columns are created up to species level.
its2.soil.taxonomylabs<-c("kingdom","phylum","class","order","family","genus","species")

#Below I create a new data frame with a column containing taxonomy information. 
t.its2.soil.rareotutabtax.table<-data.frame(taxonomy=its2.soil.taxrareinfo,t.its2.soil.rareotu.nosingles.table)

#I then separate the taxonomy strings into new columns labeled with the taxonomy labels saved in the taxonomylabs object. Strings are being separated based on the presence of semi-colons. 
t.its2.soil.rareotutabtaxsep.table<-separate(t.its2.soil.rareotutabtax.table,into=its2.soil.taxonomylabs,col=taxonomy,sep=";")

library(DT)
datatable(t.its2.soil.rareotutabtaxsep.table,fillContainer = T, height = "500px")
```

## Phylum Relative Abundance Chart
Below I generate a phylum relative abundance plot. I first extract the phylum information from the OTU table with taxonomy information. I then clean the taxa names to remove assignment confidence values and the p__ designator that precedes phylum assignment. OTU raw abundance is then summed by phylum and state, phyla that represent less than 1% of the total community are grouped into other, and relative abundance is calculated. Stacked bar charts are made using the melt function and ggplot. 
```{r Phylum Relative Abundance Chart, warning=FALSE}
#Below I create a data frame that consists of phylum assignment and the rarefied OTU table. 
t.its2.soil.raretabphy<-data.frame(phylum=t.its2.soil.rareotutabtaxsep$phylum,t.its2.soil.rareotu.nosingles)

#I then remove the assignment confidence values contained in parentheses found in each taxonomic string using the sub function and the phylum "p__" designator at the start of each taxon. 
t.its2.soil.raretabphy$phylum<-sub("\\(.*)","",x=t.its2.soil.raretabphy$phylum)
t.its2.soil.raretabphy$phylum<-sub("p__","",x=t.its2.soil.raretabphy$phylum)

#The following code is for the generation of phylum relative abundance stacked bar charts. I first sum each OTU by the phylum it belongs to. 
library(plyr)
t.its2.soil.rareotutabphy<-as.data.frame(ddply(t.its2.soil.raretabphy, .(phylum),colwise(sum)))
rownames(t.its2.soil.rareotutabphy)<-make.names(t.its2.soil.rareotutabphy$phylum)
t.its2.soil.rareotutabphy<-t.its2.soil.rareotutabphy[,2:46]

#I then transpose the data frame so that sample names are now row names and column names are OTU names. 
its2.soil.rareotutabphy<-as.data.frame(t(t.its2.soil.rareotutabphy))
its2.soil.rareotutabphy.state<-data.frame(state=its2.soil.met.rare$State,its2.soil.rareotutabphy)

#I then sum each OTU by state and subset to exclude sample names. This is because the following functions only work on matrices containing numeric data.  
its2.soil.rareotutabphy.statesum<-as.data.frame(ddply(its2.soil.rareotutabphy.state, .(state),colwise(sum)))
its2.soil.phylumcols<-its2.soil.rareotutabphy.statesum[,2:16]

#I am now creating an other category. Other includes those OTUs belonging to a phylum that comprises less than 1% of the total community. This new object is referred to as phyothers.
its2.soil.phyoth<-its2.soil.phylumcols[,colSums(its2.soil.phylumcols)/sum(its2.soil.phylumcols)<=0.01]
its2.soil.phyothers<-rowSums(its2.soil.phyoth)

#I then create an object that contains all of the phyla that comprise more than 1% of the total community. 
its2.soil.phyreg<-its2.soil.phylumcols[,colSums(its2.soil.phylumcols)/sum(its2.soil.phylumcols)>0.01]

#I then create a new dataframe containing the state information, the other column, and the remaining phyla.
its2.soil.phytot2<-data.frame(state=its2.soil.rareotutabphy.statesum$state,its2.soil.phyreg,Other=its2.soil.phyothers)

#These values are then converted to relative abundance using the decostand function from vegan. 
library(vegan)
its2.soil.phyrelabund<-decostand(its2.soil.phytot2[,2:8],method="total")
its2.soil.phyrelabund<-data.frame(state=its2.soil.rareotutabphy.statesum$state,its2.soil.phyrelabund)

#Below I use the melt function from the data.table package to reformat the data into stacked bar graph format. 
library(data.table)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
its2.soil.phyrelabundmelt<-melt(its2.soil.phyrelabund, id.vars="state", variable.name="Phylum")
its2.soil.colors.n.phylum <- length(unique(its2.soil.phyrelabundmelt[,'Phylum']))

#Below I generate the relative abundance bar charts in ggplot
its2.soil.phyrel<-ggplot(its2.soil.phyrelabundmelt, aes(x=state, y=value, fill=Phylum))+
  geom_bar(stat="identity", show.legend=TRUE, color="black")+
  scale_fill_manual(values=colorRampPalette(brewer.pal(9, 'Set1'))(its2.soil.colors.n.phylum)) +
  xlab("State") +
  ylab("Relative Abundance") +
   theme(panel.border = element_blank(),panel.background=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_text(size = 14), axis.ticks.x = element_blank(), axis.text.y = element_text(size = 14), axis.line.y.left = element_line(), axis.title.y = element_text(size = 14))+
scale_y_continuous(breaks=c(0,0.25,0.50,0.75,1),limits=c(0,1.05))+
  geom_text(data=NULL,aes(x=0.51, y=1.05,label="Soil: ITS2"),hjust=0,colour="black")

ggplotly(its2.soil.phyrel, tooltip="Phylum")
#ggsave(filename = "its2_soil_phylrelabund.png", plot(its2.soil.phyrel),dpi=300)
```

## Class Relative Abundance Chart
Below I generate a class relative abundance plot. I first extract the class information from the OTU table that contains taxonomy information. I then clean the taxa names to remove assignment confidence values, the p__ designator that precedes phylum assignment, and c__ designator that precedes class assignment. OTU raw abundance is then summed by class and state, classes that represent less than 1% of the total community are grouped into other, and relative abundance is calculated. Stacked bar charts are made using the melt function and ggplot. 
```{r Class Relative Abundance Chart,warning=FALSE}
#The following chunk creates a relative abundance bar chart at the class level. 
library(plyr)
t.its2.soil.raretabcls<-data.frame(class=t.its2.soil.rareotutabtaxsep$class,t.its2.soil.rareotu.nosingles)

#What I am doing below is cleaning up the class names. These include assignment confidence levels, p__ and c__
t.its2.soil.raretabcls$class<-sub("\\(.*)","",x=t.its2.soil.raretabcls$class)
t.its2.soil.raretabcls$class<-sub("c__","",x=t.its2.soil.raretabcls$class)
t.its2.soil.raretabcls$class<-sub("p__","",x=t.its2.soil.raretabcls$class)

#I then sum the OTUs by class and make the row names the class name. 
t.its2.soil.rareotutabcls<-as.data.frame(ddply(t.its2.soil.raretabcls, .(class),colwise(sum)))
rownames(t.its2.soil.rareotutabcls)<-make.names(t.its2.soil.rareotutabcls$class)
t.its2.soil.rareotutabcls<-t.its2.soil.rareotutabcls[,2:46]

#I then transpose the data frame and sum each class by state. 
its2.soil.rareotutabcls<-as.data.frame(t(t.its2.soil.rareotutabcls))
its2.soil.rareotutabcls.state<-data.frame(state=its2.soil.met.rare$State,its2.soil.rareotutabcls)
its2.soil.rareotutabcls.statesum<-as.data.frame(ddply(its2.soil.rareotutabcls.state, .(state),colwise(sum)))

#At the class level, UNITE may classify things as phylum_unclassified. These don't provide a lot of information and thus are grouped into a new group called unknown. 
its2.soil.clsunknown<-its2.soil.rareotutabcls.statesum[,grep("_unclassified",names(its2.soil.rareotutabcls.statesum))]
its2.soil.clsunknownsum<-rowSums(its2.soil.clsunknown)

#I then use the same grep function as above to pull out OTUs classified to the classlevel. By setting invert=TRUE I select items lacking the strings in the grep command. 
its2.soil.clstot<-its2.soil.rareotutabcls.statesum[,grep("_unclassified",names(its2.soil.rareotutabcls.statesum), invert=TRUE)]

#I then subset the data so that only numerical data is present and creating a new class of objects, other, that includes OTUs from classes that represent 1% or less of the total community. 
its2.soil.clscols<-its2.soil.clstot[,2:64]
its2.soil.clsoth<-its2.soil.clscols[,colSums(its2.soil.clscols)/sum(its2.soil.clscols)<=0.01]
its2.soil.clsothers<-rowSums(its2.soil.clsoth)
its2.soil.clsreg<-its2.soil.clscols[,colSums(its2.soil.clscols)/sum(its2.soil.clscols)>0.01]

#I then create a new data frame that contains all of the class data and determine relative abundance using the decostand function from vegan. 
its2.soil.clstot2<-data.frame(state=its2.soil.clstot$state,its2.soil.clsreg,Other=its2.soil.clsothers,Unclassified=its2.soil.clsunknownsum)
library(vegan)
its2.soil.clsrelabund<-decostand(its2.soil.clstot2[,2:14],method="total")
its2.soil.clsrelabund<-data.frame(state=its2.soil.rareotutabcls.statesum$state,its2.soil.clsrelabund)

#Below I use the melt function from the data.table package to reformat the data into stacked bar graph format.
library(data.table)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
its2.soil.clsrelabundmelt<-melt(its2.soil.clsrelabund, id.vars="state", variable.name="class")

its2.soil.cls.colorCount<- length(unique(its2.soil.clsrelabundmelt[,'class']))
getPalette=colorRampPalette(brewer.pal(9,"Set1"))

#Below I generate the relative abundance bar charts in ggplot
its2.soil.clsrel<-ggplot(its2.soil.clsrelabundmelt, aes(x=state, y=value, fill=class))+
  geom_bar(stat="identity",show.legend=TRUE,color="black")+
  scale_fill_manual(values=getPalette(its2.soil.cls.colorCount))+
  xlab("State") +
  ylab("Relative Abundance") +
    theme(panel.border = element_blank(),panel.background=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_text(size = 14), axis.ticks.x = element_blank(), axis.text.y = element_text(size = 14), axis.line.y.left = element_line(), axis.title.y = element_text(size = 14))+
scale_y_continuous(breaks=c(0,0.25,0.50,0.75,1),limits=c(0,1.05))+
  geom_text(data=NULL,aes(x=0.51, y=1.05,label="Soil: ITS2"),hjust=0,colour="black")

ggplotly(its2.soil.clsrel, tooltip="class")
#ggsave(filename = "its2_soil_clsrelabund.png", plot(its2.soil.clsrel),dpi=300)
```

## Order Relative Abundance Chart
Below I generate a order relative abundance plot. I first extract the order information from the OTU table that contains taxonomy information. I then clean the taxa names to remove assignment confidence values, the p__ designator that precedes phylum assignment, c__ designator that precedes class assignment, and the o__ designator that precedes order assignment. OTU raw abundance is then summed by order and state, orders that represent less than 1% of the total community are grouped into other, and relative abundance is calculated. Stacked bar charts are made using the melt function and ggplot.
```{r Order Relative Abundance Chart, warning=FALSE}
#The following chunk creates a relative abundance bar chart at the order level.

#What I am doing below is cleaning up the order names. These include assignment confidence levels, p__, c__, and o__
library(plyr)
t.its2.soil.raretabord<-data.frame(order=t.its2.soil.rareotutabtaxsep$order,t.its2.soil.rareotu.nosingles)
t.its2.soil.raretabord$order<-sub("\\(.*)","",x=t.its2.soil.raretabord$order)
t.its2.soil.raretabord$order<-sub("o__","",x=t.its2.soil.raretabord$order)
t.its2.soil.raretabord$order<-sub("c__","",x=t.its2.soil.raretabord$order)
t.its2.soil.raretabord$order<-sub("p__","",x=t.its2.soil.raretabord$order)

#I then sum the OTUs by class and make the row names the order name. 
t.its2.soil.rareotutabord<-as.data.frame(ddply(t.its2.soil.raretabord, .(order),colwise(sum)))
rownames(t.its2.soil.rareotutabord)<-make.names(t.its2.soil.rareotutabord$order)
t.its2.soil.rareotutabord<-t.its2.soil.rareotutabord[,2:46]

#I then transpose the data frame and sum each order by state. 
its2.soil.rareotutabord<-as.data.frame(t(t.its2.soil.rareotutabord))
its2.soil.rareotutabord.state<-data.frame(state=its2.soil.met.rare$State,its2.soil.rareotutabord)
its2.soil.rareotutabord.statesum<-as.data.frame(ddply(its2.soil.rareotutabord.state, .(state),colwise(sum)))

#At the order level, UNITE may classify things as phylum_unclassified or class_unclassified. These don't provide a lot of information and thus are grouped into a new group called unknown. 
its2.soil.ordunknown<-its2.soil.rareotutabord.statesum[,grep("_unclassified",names(its2.soil.rareotutabord.statesum))]

#I then use the same grep function as above to pull out OTUs classified to the order level. By setting invert=TRUE I select items lacking the strings in the grep command. 
its2.soil.ordunknownsum<-rowSums(its2.soil.ordunknown)
its2.soil.ordtot<-its2.soil.rareotutabord.statesum[,grep("_unclassified",names(its2.soil.rareotutabord.statesum), invert=TRUE)]

#I then subset the data so that only numerical data is present and create a new class of objects, other, that includes OTUs from orders that represent 1% or less of the total community. 
its2.soil.ordcols<-its2.soil.ordtot[,2:159]
its2.soil.ordoth<-its2.soil.ordcols[,colSums(its2.soil.ordcols)/sum(its2.soil.ordcols)<=0.01]
its2.soil.ordothers<-rowSums(its2.soil.ordoth)
its2.soil.ordreg<-its2.soil.ordcols[,colSums(its2.soil.ordcols)/sum(its2.soil.ordcols)>0.01]

#I then create a new data frame that contains all of the order data and determine relative abundance using the decostand function from vegan. 
library(vegan)
its2.soil.ordtot2<-data.frame(state=its2.soil.ordtot$state,its2.soil.ordreg,Other=its2.soil.ordothers, Unclassified=its2.soil.ordunknownsum)
its2.soil.ordrelabund<-decostand(its2.soil.ordtot2[,2:22],method="total")
its2.soil.ordrelabund<-data.frame(state=its2.soil.rareotutabord.statesum$state,its2.soil.ordrelabund)

#Below I use the melt function from the data.table package to reformat the data into stacked bar graph format.
library(data.table)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
its2.soil.ordrelabundmelt<-melt(its2.soil.ordrelabund, id.vars="state", variable.name="order")

its2.soil.ord.colorCount<- length(unique(its2.soil.ordrelabundmelt[,'order']))
getPalette=colorRampPalette(brewer.pal(9,"Set1"))

#Below I generate the relative abundance bar charts in ggplot
its2.soil.ordrel<-ggplot(its2.soil.ordrelabundmelt, aes(x=state, y=value, fill=order))+
  geom_bar(stat="identity",show.legend=TRUE,color="black")+
  scale_fill_manual(values=getPalette(its2.soil.ord.colorCount))+
  xlab("State") +
  ylab("Relative Abundance") +
    theme(panel.border = element_blank(),panel.background=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_text(size = 14), axis.ticks.x = element_blank(), axis.text.y = element_text(size = 14), axis.line.y.left = element_line(), axis.title.y = element_text(size = 14))+
scale_y_continuous(breaks=c(0,0.25,0.50,0.75,1),limits=c(0,1.05))+
  geom_text(data=NULL,aes(x=0.5, y=1.05,label="Soil: ITS2"),hjust=0,colour="black")

ggplotly(its2.soil.ordrel, tooltip="order")


#ggsave(filename = "its2_soil_ordrelabund.png", plot(its2.soil.ordrel),dpi=300)
```

### Relative Abundance Panel
```{r Relative Abundance Panel}
#This chunk creates a panel containing phylum, class, and order relative abundance charts. 
library(ggpubr)
its2.soil.relab.panel<-ggarrange(its2.soil.phyrel,its2.soil.clsrel,its2.soil.ordrel, ncol=3,nrow=1,labels=c("A","B","C"))
#ggsave(filename = "its2_soil_relabundpanel.png", plot(its2.soil.relab.panel),dpi=300)
```

# OTU Renaming
To give OTUs more meaningful names, taxonomy strings can be subset to change the OTU ID to unique taxonomic ID. Similar to the relative abundance charts, the taxonomy file must first me added to a transposed OTU table, taxonomy strings need to be split into different classification levels, and the lowest level of classification can be used to replace the original OTU ID. For instance, if an OTU received Ascomycota as its highest level of classification, the OTU ID would be changed to Ascomycota1. 

## Taxonomy Filtering
Taxonomy is first filtered to include only those OTUs present in the rarefied OTU table with no singletons. Then the OTU table is transposed so that OTU ID is the row name and sample ID is the column name. Taxonomy strings are then added to the OTU table and strings are split by semi-colon. 
```{r Taxonomy Filtering and Merging, warning=FALSE}
#Below I am reformatting the OTU table so that I can begin to filter and merge the taxonomy information. 
#I first transpose the rarefied OTU table with no singletons.
t.its2.soil.rareotu.nosingles<-as.data.frame(t(its2.soil.rareotu.nosingles))

#The below function is asking specifically for the OTU Isoil. These are the row names. I will use these to subset the taxonomy file. 
t.its2.soil.rareotu.nosingleslabs<-labels(t.its2.soil.rareotu.nosingles)
its2.soil.taxrare<-subset(its2.taxonomy.soil, rownames(its2.taxonomy.soil) %in% t.its2.soil.rareotu.nosingleslabs[[1]])
its2.soil.taxrareinfo<-(its2.soil.taxrare[,2])

#Below I am using the separate function from tidyr to split the taxonomy strings into columns by semi-colon so that I can rename the OTUs to give them more meaning for downstream analyses.
library(tidyr)
its2.soil.taxonomylabs<-c("kingdom","phylum","class","order","family","genus","species")
t.its2.soil.rareotutabtax<-data.frame(taxonomy=its2.soil.taxrareinfo,t.its2.soil.rareotu.nosingles)
t.its2.soil.rareotutabtaxsep<-separate(t.its2.soil.rareotutabtax,into=its2.soil.taxonomylabs,col=taxonomy,sep=";")
```

## Renaming of OTUs
OTUs are then renamed. Prior to official renaming, taxonomy strings are cleaned so that assignment confidence values and taxon leaders (e.g. p__, c__, etc.) are removed. 
```{r Renaming of OTUs}
#Here I am renaming the OTUs using the make.names function. This will make the OTU name something more informative. I am using species to do this. 
t.its2.soil.rareotutabtaxsep$species<-sub("\\(.*)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(_unclassified)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(p__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(c__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(o__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(f__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(g__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(s__)","",x=t.its2.soil.rareotutabtaxsep$species)
rownames(t.its2.soil.rareotutabtaxsep)<-make.names(t.its2.soil.rareotutabtaxsep$species,unique=TRUE)
t.its2.soil.rareotutabtax.rename<-t.its2.soil.rareotutabtaxsep[,8:52]
its2.soil.rareotutabtax.rename<-as.data.frame(t(t.its2.soil.rareotutabtax.rename))
```

# Principal Coordinate Analysis (PCoA)
To visually assess differences in the community composition of soil fungal communities by clone and state, I perform a principal coordinate analysis (PCoA). 
## Relative Abundance Calculation
Prior to conducting a PCoA I first convert my OTU table from raw OTU abundances to relative abundance. 
```{r Relative Abundance Calculation}
#Below I convert raw abundances to relative abundance using the decostand function from vegan. 
library(vegan)
its2.soil.relabund<-decostand(its2.soil.rareotutabtax.rename, method="total")
```

## Principal Coordinate Analysis
I then perform the PCoA using the pcoa function from the ape package. Prior to performing the PCoA, a distance matrix needs to be calculated for the OTU table. In this case, I use the bray-curtis method. 
```{r Principal Coordinate Analysis}
#Below I calculate the distance matrix using the bray-curtis method and then perform the principal coordinate analysis on the relativized OTU table. 
its2.soil.bacdist<-vegdist(its2.soil.relabund, method="bray")
library(ape)
its2.soil.bac.pcoa<-pcoa(its2.soil.bacdist)
#biplot(its2.soil.bac.pcoa,plot.axes = c(1,2))
```

## Plotting of Principal Coordinate Analysis
Then to plot the PCoA, I use the ggplot function. To use ggplot I need to first pull out the site scores for each sample and generate ellipses. 
```{r PCoA}
#We need to first subset our metadata table to include only those samples that passed rarefaction.  
its2.soil.met.rare<-subset(its2.soil.met,its2.soil.met$Group%in%labels(its2.soil.rareotu.wsingles)[[1]])

#Then we extract PCoA site scores (these will be the x and y coordinates for each sample)
its2.soil.bac.pcoavec<-as.data.frame(its2.soil.bac.pcoa$vectors)
its2.soil.bac.pcoasitescores<-data.frame(PC1=its2.soil.bac.pcoavec$Axis.1, PC2=its2.soil.bac.pcoavec$Axis.2)

#Create a new dataframe that includes the site scores from above with metadata from your study. 
its2.soil.bac.pcoagraph<-data.frame(its2.soil.bac.pcoasitescores,PC1=its2.soil.bac.pcoasitescores$PC1, PC2=its2.soil.bac.pcoasitescores$PC2, State=its2.soil.met.rare$State, Clone=its2.soil.met.rare$Clone,group=its2.soil.met.rare$Group)

#This is where you make confidence ellipses. I don't know what all the code means. Just know where to plug in my objects. 
its2.soil.bac.pcoaellipse<-ordiellipse(its2.soil.bac.pcoasitescores,its2.soil.bac.pcoagraph$State, display="sites", kind="sd", draw="none")

df_ell.soil <- data.frame()
for(g in levels(its2.soil.bac.pcoagraph$State)){
df_ell.soil <- rbind(df_ell.soil, cbind(as.data.frame(with(its2.soil.bac.pcoagraph[its2.soil.bac.pcoagraph$State==g,],                                                vegan:::veganCovEllipse(its2.soil.bac.pcoaellipse[[g]]$cov,its2.soil.bac.pcoaellipse[[g]]$center,its2.soil.bac.pcoaellipse[[g]]$scale))) ,State=g))}

#Plot PCoA in ggplot
library(ggplot2)
its2.soil.pcoa<-ggplot(its2.soil.bac.pcoagraph, aes(PC1,PC2, colour=State))+
  #geom_text(aes(label=group))+
  geom_path(data=df_ell.soil, aes(x=PC1, y=PC2, colour=State),size=0.5, linetype=1)+
  xlab("PC1 (20.4%)")+
  ylab("PC2 (13.7%)")+
  geom_point(aes(shape=Clone), size=3.5)+
 theme(axis.title.x=element_text(size=14, face="bold"))+
  theme(axis.title.y=element_text(size=14, face="bold"))+
  theme(axis.text.x=element_text(size=12, face="bold"))+
  theme(axis.text.y=element_text(size=12, face="bold"))+ 
  scale_color_manual(values=c("#006600","#3399FF","#FF9900"))+
  scale_shape_manual(values=c(16,10,8,7,0,2))+
  scale_x_continuous(breaks=c(-0.60,-0.30,0,0.30,0.60),limits=c(-0.60,0.60))+
  scale_y_continuous(breaks=c(-0.60,-0.30,0,0.30,0.60),limits=c(-.60,.60))+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
    panel.border=element_rect(colour="black", size=1, fill=NA))+
  theme(panel.grid.major=element_blank(),
       panel.grid.minor=element_blank(),
       panel.background = element_blank(),
  panel.border=element_rect(color="black", size=1, fill=NA))+
  geom_text(data=NULL,aes(x=-0.60,y=0.60,label="Soil: ITS2"),hjust=0,colour="black")
its2.soil.pcoa
#ggsave(filename = "ITS2_soil_pcoa.png", plot(its2.soil.pcoa),dpi=300)
```

## PERMANOVA 
To formally test how well state and clone explain differences in soil fungal community composition, I perform a PERMANOVA using the adonis function from vegan. 
```{r Permanovas}
#Below I perform permanovas by state and clone using the adonis function from vegan. 
library(vegan)

its2.soil.bac.perm.state.inter<-adonis(its2.soil.relabund~its2.soil.met.rare$State*its2.soil.met.rare$Clone, method="bray",permutations=10000)
its2.soil.bac.perm.state.inter

its2.soil.bac.perm.state.add<-adonis(its2.soil.relabund~its2.soil.met.rare$State+its2.soil.met.rare$Clone, method="bray",permutations=10000)
its2.soil.bac.perm.state.add

its2.soil.bac.perm.state.sing<-adonis(its2.soil.relabund~its2.soil.met.rare$State, method="bray",permutations=10000)
its2.soil.bac.perm.state.sing
```

# Richness and Diversity
Then to assess the alpha diversity of our samples, I calculate the observed richness and shannon diversity index using the vegan package. This is done using the rarefied OTU table that contains singletons. Singletons are included to keep sampling depth standard between samples. 

## Richness
Observed OTU richness is first calculated for each sample. Then due to the unbalanced nature of our study design, we use a type 3 ANOVA. 
```{r Richness}
#In this chunk we calculate richness and create a data frame including richness with metadata

#I first import my rarefied OTU table that contains singletons.
its2.soil.rareotu.wsingles<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2otutable.rarefied_jnigra17_fa19_gw.shared", header=TRUE, sep="\t")

#I then remove mothur associated metadata present in the first 3 columns.
its2.soil.rareotu<-as.data.frame(its2.soil.rareotu.wsingles[,4:10580])

#Below I calculate observed species richness using the specnumber function from vegan. I then create a new data frame to include sample metadata. 
library(vegan)
its2.soil.fungi.rich<-specnumber(its2.soil.rareotu)
its2.soil.richnesstabmet<-data.frame(State=its2.soil.met.rare$State, clone=its2.soil.met.rare$Clone, sample=its2.soil.met.rare$Group,Richness=its2.soil.fungi.rich)

#I first test for a significant interaction between state and clone. Due to the unbalanced design we use a type 3 ANOVA. 
library(car)
its2.soil.anova.typ3.rich<-aov((Richness)~State*clone, data=its2.soil.richnesstabmet)
its2.soil.typ3aov.rich<-Anova(its2.soil.anova.typ3.rich,type="III")
its2.soil.typ3aov.rich
kable(its2.soil.typ3aov.rich)

#The below two lines generate plots to evaluate regression assumptions. 
par(mfrow=c(2,2))
plot(its2.soil.anova.typ3.rich)

#There was no significant interaction between state and clone so we drop the interaction term. 
its2.soil.anova.add.rich<-aov((Richness)~State+clone, data=its2.soil.richnesstabmet)
its2.soil.add.aov.rich<-Anova(its2.soil.anova.add.rich,type="III")
its2.soil.add.aov.rich
kable(its2.soil.add.aov.rich)

#Perform Tukey Test
its2.soil.add.aov.rich.tukey<-TukeyHSD(its2.soil.anova.add.rich)
its2.soil.add.aov.rich.tukey.table<-rbind(its2.soil.add.aov.rich.tukey$State,its2.soil.add.aov.rich.tukey$clone)
its2.soil.add.aov.rich.tukey.table
kable(its2.soil.add.aov.rich.tukey.table)

#The below two lines generate plots to evaluate regression assumptions. 
par(mfrow=c(2,2))
plot(its2.soil.anova.add.rich)

#There was no significant effect of clone so we drop and see just state alone. 
its2.soil.anova.sing.rich<-aov((Richness)~State, data=its2.soil.richnesstabmet)
its2.soil.sing.aov.rich<-Anova(its2.soil.anova.sing.rich,type="III")
its2.soil.sing.aov.rich
kable(its2.soil.sing.aov.rich)

#Perform Tukey Test
its2.soil.sing.aov.rich.tukey<-TukeyHSD(its2.soil.anova.sing.rich)
its2.soil.sing.aov.rich.tukey.table<-rbind(its2.soil.sing.aov.rich.tukey$State)
its2.soil.sing.aov.rich.tukey.table
kable(its2.soil.sing.aov.rich.tukey.table)

#The below two lines generate plots to evaluate regression assumptions. I keep these muted because they're annoying if you're bulk running code.
par(mfrow=c(2,2))
plot(its2.soil.anova.sing.rich)

#I then create a box plot for the richness data by state using ggplot. 
library(Hmisc)
library(ggpubr)
its2.soil.richness.summarized<-summarize(its2.soil.richnesstabmet$Richness,by=its2.soil.richnesstabmet$State, FUN=max)
its2.soil.richness.summarized<-data.frame(State=its2.soil.richness.summarized$`its2.soil.richnesstabmet$State`,Richness=its2.soil.richness.summarized$`its2.soil.richnesstabmet$Richness`)

library(ggplot2)
library(ggpubr)
#Below I create a boxplot for richness values.
its2.soil.rich<-ggboxplot(its2.soil.richnesstabmet, x="State", y="Richness", outlier.shape=NA)+
  geom_jitter(data=its2.soil.richnesstabmet,position=position_jitter(0.2), aes(shape=clone),size=3)+
  scale_shape_manual(values=c(16,10,8,7,0,2))+
  #geom_text(data=richness.summarized, aes(x=State, y = 25 + Richness, label=Group, fontface="bold"))+
  geom_text(data=NULL,aes(x=1, y=1270, label="A"))+
  geom_text(data=NULL,aes(x=2, y=1270, label="A"))+
  geom_text(data=NULL,aes(x=3, y=810, label="B"))+
  geom_text(data=NULL,aes(x=0.5,y=1400,label="Soil: ITS2"),hjust=0)+
    theme(axis.line.x=element_blank(), legend.position ="none")
its2.soil.rich
```

## Diversity
Observed OTU richness is first calculated for each sample. Then due to the unbalanced nature of our study design, we use a type 3 ANOVA.
```{r Diversity}
#In this chunk we calculate shannon diversity and create a data frame including diversity with metadata
#I first import my rarefied OTU table that contains singletons.
its2.soil.rareotu.wsingles<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits2otutable.rarefied_jnigra17_fa19_gw.shared", header=TRUE, sep="\t")

#I then remove mothur associated metadata present in the first 3 columns.
its2.soil.rareotu<-as.data.frame(its2.soil.rareotu.wsingles[,4:10580])

#Calculate shannon diversity using the diversity function of vegan
library(vegan)
its2.soil.fungi.div<-diversity (its2.soil.rareotu, index="shannon")

#I then create a new data frame to include sample metadata.
its2.soil.diversity.tabmet<-data.frame(State=its2.soil.met.rare$State, clone=its2.soil.met.rare$Clone, sample=its2.soil.met.rare$Group,Shannon=its2.soil.fungi.div)

#I first test for a significant interaction between state and clone. Due to the unbalanced design we use a type 3 ANOVA. 
library(car)
its2.soil.anova.typ3.div<-aov((Shannon)~State*clone, data=its2.soil.diversity.tabmet)
its2.soil.typ3aov.div<-Anova(its2.soil.anova.typ3.div,type="III")
its2.soil.typ3aov.div
kable(its2.soil.typ3aov.div)

#The below two lines generate plots to evaluate regression assumptions.
par(mfrow=c(2,2))
plot(its2.soil.anova.typ3.div)

#There was no significant interaction between state and clone so we drop the interaction term. 
its2.soil.anova.add.div<-aov((Shannon)~State+clone, data=its2.soil.diversity.tabmet)
its2.soil.add.aov.div<-Anova(its2.soil.anova.add.div,type="III")
its2.soil.add.aov.div
kable(its2.soil.add.aov.div)

#Perform Tukey test
its2.soil.anova.add.div.tukey<-TukeyHSD(its2.soil.anova.add.div)
its2.soil.anova.add.div.tukey.table<-rbind(its2.soil.anova.add.div.tukey$State,its2.soil.anova.add.div.tukey$clone)
its2.soil.anova.add.div.tukey.table
kable(its2.soil.anova.add.div.tukey.table)

#The below two lines generate plots to evaluate regression assumptions. 
par(mfrow=c(2,2))
plot(its2.soil.anova.add.div)

#There was no significant interaction between state and clone so we drop clone from the model. 
its2.soil.anova.sing.div<-aov((Shannon)~State, data=its2.soil.diversity.tabmet)
its2.soil.sing.aov.div<-Anova(its2.soil.anova.sing.div,type="III")
its2.soil.sing.aov.div
kable(its2.soil.sing.aov.div)

#Perform Tukey test
its2.soil.anova.sing.div.tukey<-TukeyHSD(its2.soil.anova.sing.div)
its2.soil.anova.sing.div.tukey.table<-rbind(its2.soil.anova.sing.div.tukey$State)
its2.soil.anova.sing.div.tukey.table
kable(its2.soil.anova.sing.div.tukey.table)

#The below two lines generate plots to evaluate regression assumptions. 
par(mfrow=c(2,2))
plot(its2.soil.anova.sing.div)

#I then create a box plot for the richness data by state using ggplot. 
library(Hmisc)
library(ggpubr)
its2.soil.diversity.summarized<-summarize(its2.soil.diversity.tabmet$Shannon,by=its2.soil.diversity.tabmet$State, FUN=max)
its2.soil.diversity.summarized<-data.frame(State=its2.soil.diversity.summarized$`its2.soil.diversity.tabmet$State`,Diversity=its2.soil.diversity.summarized$`its2.soil.diversity.tabmet$Shannon`)

library(ggplot2)
library(ggpubr)
#Below I create a boxplot for richness values.
its2.soil.div<-ggboxplot(its2.soil.diversity.tabmet, x="State", y="Shannon", outlier.shape=NA)+
  geom_jitter(data=its2.soil.diversity.tabmet,position=position_jitter(0.2), aes(shape=clone),size=3)+
  scale_shape_manual(values=c(16,10,8,7,0,2))+
  #geom_text(data=diversity.summarized, aes(x=State, y = 0.5 + Diversity, label=group, fontface="bold"))+
  geom_text(data=NULL,aes(x=0.5,y=5.75,label="Soil: ITS2"),hjust=0)+
  theme(axis.line.x=element_blank(), legend.position ="none")
its2.soil.div

its2.soilalphdiv<-ggarrange(its2.soil.rich,its2.soil.div,ncol=1,nrow=2, align="v")
its2.soilalphdiv
#ggsave(filename = "its2_soil_alphdiv.png", plot(its2.soilalphdiv),dpi=300)
```

# OTU Renaming
To give OTUs more meaningful names, taxonomy strings can be subset to change the OTU ID to unique taxonomic ID. Similar to the relative abundance charts, the taxonomy file must first me added to a transposed OTU table, taxonomy strings need to be split into different classification levels, and the lowest level of classification can be used to replace the original OTU ID. For instance, if an OTU received Ascomycota as its highest level of classification, the OTU ID would be changed to Ascomycota1. 

## Taxonomy Filtering
Taxonomy is first filtered to include only those OTUs present in the rarefied OTU table with no singletons. Then the OTU table is transposed so that OTU ID is the row name and sample ID is the column name. Taxonomy strings are then added to the OTU table and strings are split by semi-colon. 
```{r Taxonomy Filtering and Merging, warning=FALSE}
#Below I am reformatting the OTU table so that I can begin to filter and merge the taxonomy information. 
#I first transpose the rarefied OTU table with no singletons.
t.its2.soil.rareotu.nosingles<-as.data.frame(t(its2.soil.rareotu.nosingles))

#The below function is asking specifically for the OTU Isoil. These are the row names. I will use these to subset the taxonomy file. 
t.its2.soil.rareotu.nosingleslabs<-labels(t.its2.soil.rareotu.nosingles)
its2.soil.taxrare<-subset(its2.taxonomy.soil, rownames(its2.taxonomy.soil) %in% t.its2.soil.rareotu.nosingleslabs[[1]])
its2.soil.taxrareinfo<-(its2.soil.taxrare[,2])

#Below I am using the separate function from tidyr to split the taxonomy strings into columns by semi-colon so that I can rename the OTUs to give them more meaning for downstream analyses.
library(tidyr)
its2.soil.taxonomylabs<-c("kingdom","phylum","class","order","family","genus","species")
t.its2.soil.rareotutabtax<-data.frame(taxonomy=its2.soil.taxrareinfo,t.its2.soil.rareotu.nosingles)
t.its2.soil.rareotutabtaxsep<-separate(t.its2.soil.rareotutabtax,into=its2.soil.taxonomylabs,col=taxonomy,sep=";")
```

## Renaming of OTUs
OTUs are then renamed. Prior to official renaming, taxonomy strings are cleaned so that assignment confidence values and taxon leaders (e.g. p__, c__, etc.) are removed. 
```{r Renaming of OTUs}
#Here I am renaming the OTUs using the make.names function. This will make the OTU name something more informative. I am using species to do this. 
t.its2.soil.rareotutabtaxsep$species<-sub("\\(.*)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(_unclassified)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(p__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(c__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(o__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(f__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(g__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.soil.rareotutabtaxsep$species<-sub("(s__)","",x=t.its2.soil.rareotutabtaxsep$species)
t.its2.ds.rareotutabtaxsep$species<-sub("_sp","",x=t.its2.ds.rareotutabtaxsep$species)
rownames(t.its2.soil.rareotutabtaxsep)<-make.names(paste(rownames(t.its2.soil.rareotutabtaxsep),t.its2.soil.rareotutabtaxsep$species,sep="_"))
t.its2.soil.rareotutabtax.rename<-t.its2.soil.rareotutabtaxsep[,8:52]
its2.soil.rareotutabtax.rename<-as.data.frame(t(t.its2.soil.rareotutabtax.rename))
```

```{r}
library(indicspecies)
set.seed(577)
indicspecies.its2.soil<-multipatt(its2.soil.rareotutabtax.rename, its2.soil.met.rare$State,func="IndVal.g",control=how(nperm=10000))
options(max.print=1000000)
sink(file="its2.soil.indicators.txt")
summary(indicspecies.its2.soil,indvalcomp=TRUE)
sink()

its2.soil.met.rare
tcd.status.soil<-c("Negative","Positive","Positive","Negative","Negative","Positive","Negative","Positive","Negative","Negative","Positive","Positive")
set.seed(577)
indicspecies.its2.disease.soil<-multipatt(its2.soil.rareotutabtax.rename[34:45,], tcd.status.soil,func="IndVal.g",control=how(nperm=10000))
sink(file="its2.soil.tcdindicators.txt")
summary(indicspecies.its2.disease.soil,indvalcomp=TRUE)
sink()
```

```{r}
its2.soil.indicators<-read.table("/Volumes/AaronOnufrakMac/researchprojects_2019.2022_ajo/j.nigra_microbiome_2017_ajo_gmw/soilits2statistics_jnigra17_su19_ajo/soilits_indicatoranalysis_sp20_ajo.csv",header=TRUE,sep=",")

library(tidyr)
its2.soil.indicators.long<-as.data.frame(pivot_longer(its2.soil.indicators, cols=c("Specificity","Sensitivity","Indicator.Value"),"Statistic"))

in.its2.soil.indicators<-subset(its2.soil.indicators.long,its2.soil.indicators.long[,3]=="IN")
tn.its2.soil.indicators<-subset(its2.soil.indicators.long,its2.soil.indicators.long[,3]=="TN")
tn.in.its2.soil.indicators<-subset(its2.soil.indicators.long,its2.soil.indicators.long[,3]=="IN+TN")
wa.its2.soil.indicators<-subset(its2.soil.indicators.long,its2.soil.indicators.long[,3]=="WA")
tcd.positive.its2.soil.indicators<-subset(its2.soil.indicators.long,its2.soil.indicators.long[,3]=="Positive")
tcd.negative.its2.soil.indicators<-subset(its2.soil.indicators.long,its2.soil.indicators.long[,3]=="Negative")

its2.soil.indicator.mat<-its2.soil.indicators[c(1:10,21:30,41:50,61:70,81:89),2:4]
rownames(its2.soil.indicator.mat)<-its2.soil.indicators$OTU[c(1:10,21:30,41:50,61:70,81:89)]
colnames(its2.soil.indicator.mat)<-colnames(its2.soil.indicators)[2:4]

its2.soil.indicator.row.dat<-data.frame(State=its2.soil.indicators$Group,Mycoparasite=as.factor(its2.soil.indicators$Mycoparasite),Plant.Pathogen=as.factor(its2.soil.indicators$Plant.Pathogen), Arbuscular.Mycorrhizal=as.factor(its2.soil.indicators$Arbuscular.Mycorrhizal))
rownames(its2.soil.indicator.row.dat)<-make.names(its2.soil.indicators$OTU)

annotation_colors<-list(
  Plant.Pathogen = c(Yes="maroon", No="white"),
  Mycoparasite = c(Yes="khaki4", No="white"),
  Arbuscular.Mycorrhizal=c(Yes="dodgerblue4", No="white"),
  State=c(IN="springgreen3", IN.TN="slateblue2", TN="skyblue1", WA="violet",Negative="olivedrab1", Positive="darkslategrey")
)

my_colors<-colorRampPalette(colors=c("darkblue","lightblue"))

library(ClassDiscovery)
library(pheatmap)
its.soil.heatmap<-pheatmap(its2.soil.indicator.mat,
         annotation_row=its2.soil.indicator.row.dat,
         color=gray.colors(15),
         cluster_rows=FALSE,
         cluster_cols=FALSE,
         gaps_row=c(10,20,30,40,46),
         annotation_colors=annotation_colors,
         cellwidth=10)

ggsave("its.soil.indicator.png",its.soil.heatmap,height = 15,width=15,dpi=300)
```

